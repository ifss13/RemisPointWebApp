{% extends 'base.html' %}
{% block title %}Panel del Chofer - RemisPoint{% endblock %}

{% block content %}
<style>
    /* Ajustes generales para dispositivos móviles */
    body {
        font-size: 16px;
    }
    .container {
        max-width: 100%;
        padding: 15px;
    }
    h2, h3 {
        font-size: 1.5rem;
    }
    .btn {
        width: 100%;
        font-size: 1.2rem;
    }
    #mapa-container {
        height: 50vh;
        width: 100%;
        border-radius: 10px;
    }
</style>
<div class="container mt-4">
    <h2 class="text-center">Panel del Chofer</h2>
    
    <!-- Pestañas -->
    <ul class="nav nav-tabs nav-justified" id="choferTabs">
        <li class="nav-item">
            <a class="nav-link active" id="esperando-tab" data-bs-toggle="tab" href="#esperando">Esperando Viajes</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="registro-tab" data-bs-toggle="tab" href="#registro">Registro de Viajes</a>
        </li>
    </ul>

    <div class="tab-content mt-3">
        <!-- Pestaña Esperando Viajes -->
        <div class="tab-pane fade show active text-center" id="esperando">
            <div id="viaje-encontrado" style="display: none;">
                <h3>Has sido asignado un viaje</h3>
                <p id="info-viaje"></p>
                <button id="aceptar-viaje" class="btn btn-primary">Salir a la dirección de destino</button>
            </div>

            <div id="esperando-viaje">
                <!-- Animación Lottie -->
                <div id="lottie-container" style="width: 80%; max-width: 250px; height: auto;"></div>
                <h4 class="mt-3">Esperando asignaciones de viaje</h4>
                
                <!-- Switch de disponibilidad -->
                <div class="form-check form-switch mt-3">
                    <input class="form-check-input" type="checkbox" id="disponibilidadSwitch" {% if chofer_auto.disponibilidad %}checked{% endif %}>
                    <label class="form-check-label" for="disponibilidadSwitch" id="estado-label">
                        {% if chofer_auto.disponibilidad %}Disponible{% else %}No disponible{% endif %}
                    </label>
                </div>
            </div>

            <!-- Mapa (se mostrará al aceptar el viaje) -->
            <div id="mapa-container" style="display: none; height: 400px;"></div>
        </div>

        <!-- Pestaña Registro de Viajes (en blanco por ahora) -->
        <div class="tab-pane fade text-center" id="registro">
            <p class="mt-3">En construcción...</p>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.9.6/lottie.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<script>
    var animation = lottie.loadAnimation({
        container: document.getElementById('lottie-container'),
        renderer: 'svg',
        loop: true,
        autoplay: true,
        path: "/static/animaciones/Animacion_chofer_espera.json"
    });

    // ✅ Manejar el cambio de disponibilidad del chofer
    document.getElementById('disponibilidadSwitch').addEventListener('change', function () {
        let estado = this.checked;
        document.getElementById('estado-label').textContent = estado ? "Disponible" : "No disponible";
        actualizarEstadoChofer(estado);
    });

    function actualizarEstadoChofer(disponible) {
        fetch("/actualizar_estado_chofer/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ disponible: disponible })
        })
        .then(response => response.json())
        .then(data => console.log("Estado actualizado:", data))
        .catch(error => console.error("Error al actualizar estado:", error));
    }

    // ✅ Verificar si hay un viaje asignado cada 5 segundos
    function verificarAsignacion() {
        fetch("/verificar_viaje_asignado/")
        .then(response => response.json())
        .then(data => {
            if (data.asignado) {
                document.getElementById('esperando-viaje').style.display = 'none';
                document.getElementById('viaje-encontrado').style.display = 'block';
                document.getElementById('info-viaje').textContent = `Dirigirse a: ${data.dir_salida}`;

                document.getElementById('aceptar-viaje').onclick = function () {
                    cambiarEstadoViaje(data.id_viaje, data.dir_salida, data.dir_destino);
                };
            }
        })
        .catch(error => console.error("Error al verificar asignación:", error));
    }

    // ✅ Cambiar el estado del viaje cuando el chofer acepta
    function cambiarEstadoViaje(id_viaje, dir_salida, dir_destino) {
        fetch(`/cambiar_estado_viaje/${id_viaje}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ estado: "En camino al cliente" })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('viaje-encontrado').style.display = 'none';
                mostrarMapa(dir_salida, dir_destino, id_viaje);
            }
        })
        .catch(error => console.error("Error al cambiar estado del viaje:", error));
    }

    // ✅ Mostrar mapa y generar ruta desde el chofer hasta la dirección de salida
    function mostrarMapa(dir_salida, dir_destino, id_viaje) {
        document.getElementById('mapa-container').style.display = 'block';
        var map = L.map('mapa-container').setView([-27.485045, -55.1199269], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(async function (position) {
                const choferCoords = [position.coords.longitude, position.coords.latitude];  // ORS usa [long, lat]
                console.log("Ubicación actual del chofer:", choferCoords);

                const direccionSalida = `${dir_salida}, Oberá, Misiones`;

                try {
                    const salidaCoords = await obtenerCoordenadas(direccionSalida);
                    console.log("Coordenadas de salida:", salidaCoords);

                    generarRutaORS(choferCoords, salidaCoords, map);

                    // ✅ Mostrar el botón "Iniciar Viaje"
                    document.getElementById('iniciar-viaje').style.display = 'block';
                    document.getElementById('iniciar-viaje').onclick = function () {
                        iniciarViaje(id_viaje, dir_salida, dir_destino, map);
                    };

                } catch (error) {
                    console.error("Error al obtener coordenadas de salida:", error);
                }

            }, function (error) {
                console.error("Error obteniendo la ubicación del chofer:", error);
            });
        } else {
            console.error("Geolocalización no está soportada en este navegador.");
        }
    }

    // ✅ Obtener coordenadas de una dirección
    async function obtenerCoordenadas(direccion) {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion)}`);
        const data = await response.json();
        if (data.length > 0) {
            return [parseFloat(data[0].lon), parseFloat(data[0].lat)];
        } else {
            throw new Error("No se encontraron coordenadas para la dirección.");
        }
    }

    // ✅ Obtener API Key de OpenRouteService
    async function obtenerApiKey() {
        const response = await fetch('/obtener-api-key/');
        const data = await response.json();
        if (data.api_key) {
            return data.api_key;
        }
        throw new Error("No se pudo obtener la API Key");
    }

    // ✅ Generar la ruta en OpenRouteService
    async function generarRutaORS(origen, destino, map) {
        console.log("Generando ruta con ORS desde", origen, "hasta", destino);

        try {
            const apiKey = await obtenerApiKey();
            const response = await fetch(`https://api.openrouteservice.org/v2/directions/driving-car?api_key=${apiKey}&start=${origen[0]},${origen[1]}&end=${destino[0]},${destino[1]}`);
            const data = await response.json();

            if (data.features) {
                const coordenadasRuta = data.features[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
                L.polyline(coordenadasRuta, { color: 'blue', weight: 5 }).addTo(map);
                map.fitBounds(L.polyline(coordenadasRuta).getBounds());
            } else {
                console.error("No se pudo generar la ruta con OpenRouteService.");
            }
        } catch (error) {
            console.error("Error al obtener la ruta de OpenRouteService:", error);
        }
    }

    // ✅ Iniciar el viaje: cambiar estado, limpiar mapa y generar nueva ruta
    function iniciarViaje(id_viaje, dir_salida, dir_destino, map) {
        fetch(`/cambiar_estado_viaje/${id_viaje}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ estado: "En viaje" })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log("Viaje iniciado, generando nueva ruta...");

                // Limpiar el mapa y generar la ruta desde salida a destino
                map.eachLayer(function (layer) {
                    if (!!layer.toGeoJSON) {
                        map.removeLayer(layer);
                    }
                });

                obtenerCoordenadas(`${dir_destino}, Oberá, Misiones`)
                .then(destinoCoords => {
                    obtenerCoordenadas(`${dir_salida}, Oberá, Misiones`)
                    .then(salidaCoords => {
                        generarRutaORS(salidaCoords, destinoCoords, map);
                    });
                });
            }
        })
        .catch(error => console.error("Error al iniciar viaje:", error));
    }

    // ✅ Verificar cada 5 segundos si hay un viaje asignado
    setInterval(verificarAsignacion, 5000);
</script>






{% endblock %}
